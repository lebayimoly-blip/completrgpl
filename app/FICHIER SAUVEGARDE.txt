from fastapi import APIRouter, Depends, HTTPException, UploadFile, File, Form
from sqlalchemy.orm import Session
from app import models, schemas, database, auth
from app.utils.files import UPLOAD_DIR, generate_family_filename

router = APIRouter(prefix="/familles", tags=["familles"])

# --- Création d'une famille ---
from app.utils.files import UPLOAD_DIR, generate_family_filename

@router.post("/", response_model=schemas.FamilleResponse)
async def create_famille(..., photo: UploadFile = File(None), ...):
    db_famille = models.Famille(
        ...,
    )
    db.add(db_famille)
    db.commit()
    db.refresh(db_famille)

    if photo:
        filename = generate_family_filename(db_famille.id, photo.filename)
        photo_path = os.path.join(UPLOAD_DIR, filename)

        with open(photo_path, "wb") as buffer:
            buffer.write(await photo.read())

        db_famille.photo_path = photo_path
        db.commit()
        db.refresh(db_famille)

    return db_famille


# --- Ajout d'un membre à une famille ---
@router.post("/{famille_id}/members", response_model=schemas.MembreResponse)
def add_member(
    famille_id: int,
    membre: schemas.MembreCreate,
    db: Session = Depends(database.get_db),
):
    db_famille = db.query(models.Famille).filter(models.Famille.id == famille_id).first()
    if not db_famille:
        raise HTTPException(status_code=404, detail="Famille non trouvée")

    db_membre = models.Membre(
        first_name=membre.first_name,
        last_name=membre.last_name,
        role=membre.role,
        date_of_birth=membre.date_of_birth,
        gender=membre.gender,
        nationality=membre.nationality,
        id_type=membre.id_type,
        id_number=membre.id_number,
        place_of_birth=membre.place_of_birth,
        province=membre.province,
        city=membre.city,
        district=membre.district,
        famille_id=famille_id,
    )

    db.add(db_membre)
    db.commit()
    db.refresh(db_membre)
    return db_membre


# --- Liste des membres d'une famille ---
@router.get("/{famille_id}/members", response_model=list[schemas.MembreResponse])
def list_members(famille_id: int, db: Session = Depends(database.get_db)):
    db_famille = db.query(models.Famille).filter(models.Famille.id == famille_id).first()
    if not db_famille:
        raise HTTPException(status_code=404, detail="Famille non trouvée")
    return db_famille.membres


# --- Supprimer un membre d'une famille ---
@router.delete("/{famille_id}/members/{membre_id}")
def delete_member(famille_id: int, membre_id: int, db: Session = Depends(database.get_db)):
    db_membre = db.query(models.Membre).filter(
        models.Membre.id == membre_id,
        models.Membre.famille_id == famille_id
    ).first()
    if not db_membre:
        raise HTTPException(status_code=404, detail="Membre non trouvé")

    db.delete(db_membre)
    db.commit()
    return {"message": "Membre supprimé"}


# --- Mise à jour de la localisation ---
@router.post("/{famille_id}/localisation")
def update_localisation(
    famille_id: int,
    localisation: schemas.LocalisationCreate,
    db: Session = Depends(database.get_db),
):
    db_famille = db.query(models.Famille).filter(models.Famille.id == famille_id).first()
    if not db_famille:
        raise HTTPException(status_code=404, detail="Famille non trouvée")

    db_famille.latitude = localisation.latitude
    db_famille.longitude = localisation.longitude
    db.commit()
    return {"message": "Localisation mise à jour"}


# --- Mise à jour de la durée de remplissage ---
@router.post("/{famille_id}/duree")
def update_duree(
    famille_id: int,
    duree: schemas.DureeCreate,
    db: Session = Depends(database.get_db),
):
    db_famille = db.query(models.Famille).filter(models.Famille.id == famille_id).first()
    if not db_famille:
        raise HTTPException(status_code=404, detail="Famille non trouvée")

    db_famille.duree_remplissage = duree.duree_remplissage
    db.commit()
    return {"message": "Durée de remplissage enregistrée"} import os
from fastapi import APIRouter, Depends, HTTPException, UploadFile, File, Form
from sqlalchemy.orm import Session
from app import models, schemas, database, auth
from app.utils.files import UPLOAD_DIR, generate_family_filename  # ton utilitaire

router = APIRouter(prefix="/familles", tags=["familles"])


# --- Création d'une famille ---
@router.post("/", response_model=schemas.FamilleResponse)
async def create_famille(
    name: str = Form(...),
    first_name: str = Form(...),
    last_name: str = Form(...),
    date_of_birth: str = Form(...),
    gender: str = Form(...),
    nationality: str = Form(...),
    id_type: str = Form(...),
    id_number: str = Form(...),
    place_of_birth: str = Form(...),
    province: str = Form(...),
    city: str = Form(...),
    district: str = Form(...),
    duree_remplissage: int = Form(None),
    latitude: float = Form(None),
    longitude: float = Form(None),
    photo: UploadFile = File(None),
    db: Session = Depends(database.get_db),
    current_user: models.Utilisateur = Depends(auth.get_current_user_from_cookie),
):
    # Création de la famille en base
    db_famille = models.Famille(
        name=name,
        first_name=first_name,
        last_name=last_name,
        date_of_birth=date_of_birth,
        gender=gender,
        nationality=nationality,
        id_type=id_type,
        id_number=id_number,
        place_of_birth=place_of_birth,
        province=province,
        city=city,
        district=district,
        duree_remplissage=duree_remplissage,
        latitude=latitude,
        longitude=longitude,
        created_by_id=current_user.id,
    )
    db.add(db_famille)
    db.commit()
    db.refresh(db_famille)

    # Sauvegarde du fichier photo si fourni
    if photo:
        filename = generate_family_filename(db_famille.id, photo.filename)
        photo_path = os.path.join(UPLOAD_DIR, filename)

        with open(photo_path, "wb") as buffer:
            buffer.write(await photo.read())

        db_famille.photo_path = photo_path
        db.commit()
        db.refresh(db_famille)

    return db_famille

