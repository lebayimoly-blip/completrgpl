{% extends "base.html" %}

{% block title %}Utilisateurs{% endblock %}

{% block content %}
{% if current_user.role in ["super_admin", "superviseur_provincial"] %}
<h1>Liste des utilisateurs</h1>

<!-- Debug : nombre de provinces -->
<p>Provinces disponibles : {{ provinces | length }}</p>

<!-- Formulaire pour cr√©er un nouvel utilisateur -->
<form method="post" action="/utilisateurs/" onsubmit="return setProvinceId()">
  <label>Nom d'utilisateur :</label>
  <input type="text" name="username" required>

  <label>Mot de passe :</label>
  <input type="password" name="password" required>

  <label>R√¥le :</label>
  <select name="role" required>
    <option value="agent_recenseur">Agent recenseur</option>
    <option value="chef_equipe">Chef d‚Äô√©quipe</option>
    <option value="controleur">Contr√¥leur</option>
    <option value="superviseur_provincial">Superviseur provincial</option>
    <option value="super_admin">Super admin</option>
  </select>

  <label>Province (nom exact) :</label>
  <input type="text" id="province_nom" required placeholder="Ex: Estuaire">

  <!-- Champ cach√© qui sera rempli automatiquement -->
  <input type="hidden" name="province_id" id="province_id">

  <!-- Liste des provinces disponibles -->
  <small>
    <strong>Provinces disponibles :</strong><br>
    1 ‚Äì Estuaire<br>
    2 ‚Äì Haut-Ogoou√©<br>
    3 ‚Äì Moyen-Ogoou√©<br>
    4 ‚Äì Ngouni√©<br>
    5 ‚Äì Nyanga<br>
    6 ‚Äì Ogoou√©-Ivindo<br>
    7 ‚Äì Ogoou√©-Lolo<br>
    8 ‚Äì Ogoou√©-Maritime<br>
    9 ‚Äì Woleu-Ntem
  </small>

  <br><br>
  <button type="submit" class="btn">Cr√©er l'utilisateur</button>
</form>

<!-- Liste des utilisateurs avec bouton suppression -->
{% set current_province = None %}
<ul>
  {% for u in utilisateurs %}
    {% if current_province != u.province.nom %}
      {% if not loop.first %}
        </ul>
      {% endif %}
      <hr>
      <h3>üåç Province : {{ u.province.nom }}</h3>
      <ul>
      {% set current_province = u.province.nom %}
    {% endif %}
    <li>
      {{ u.username }} ‚Äì r√¥le : {{ u.role }} ‚Äì 
      {{ u.familles|length }} famille{% if u.familles|length > 1 %}s{% endif %} cr√©√©e{% if u.familles|length > 1 %}s{% endif %}
      <form action="/utilisateurs/{{ u.id }}/delete" method="post" style="display:inline;">
        <button type="submit" style="background-color:red; color:white;">üóëÔ∏è Supprimer</button>
      </form>
    </li>
  {% endfor %}
</ul>


{% else %}
<p>‚õî Acc√®s refus√©. Cette page est r√©serv√©e aux administrateurs.</p>
{% endif %}

<!-- Retour √† l'accueil -->
<a href="/">Retour</a>

<!-- Script pour convertir nom ‚Üí ID -->
<script>
  function setProvinceId() {
    const nom = document.getElementById("province_nom").value.trim().toLowerCase();
    const mapping = {
      "estuaire": 1,
      "haut-ogoou√©": 2,
      "moyen-ogoou√©": 3,
      "ngouni√©": 4,
      "nyanga": 5,
      "ogoou√©-ivindo": 6,
      "ogoou√©-lolo": 7,
      "ogoou√©-maritime": 8,
      "woleu-ntem": 9
    };
    const id = mapping[nom];
    if (!id) {
      alert("Nom de province invalide. Veuillez utiliser un nom exact.");
      return false;
    }
    document.getElementById("province_id").value = id;
    return true;
  }
</script>
{% endblock %}
